#!/usr/bin/env zsh

is_git_repo() {
    local dir="$1"
    [[ $(git -C "$dir" rev-parse --is-inside-work-tree 2>/dev/null) == "true" ]]
}

# Validate user input
if [[ $# -gt 1 ]]; then
    echo "Too many arguments. See $(basename $0) --help.">&2
    exit 1
elif [[ "$1" == "--help" || "$1" == "-h"  ]]; then
    echo "Usage: $(basename $0) [path]"
    echo
    echo "Arguments"
    echo "    path (optional) - Path to project root directory."
    echo
    exit 0
elif [[ $# -eq 1 && ! -e "$1" ]]; then
    echo "Received an invalid path: $1">&2
    exit 1
fi

if [[ $# -eq 0 ]]; then
    selected_path=$PWD
else
    selected_path=$(realpath $1)
fi

if is_git_repo selected_path; then
    working_directory=$(git rev-parse --show-toplevel)
elif [[ -d "$1" ]]; then
    working_directory=$selected_path
else
    working_directory=$(dirname $selected_path)
fi

selected_path_hash=$(sha256 <<< "$selected_path")
session="$(basename $selected_path  | tr . _)-${selected_path_hash:0:4}"

if ! tmux has-session -t=$session 2> /dev/null; then
    tmux new-session -ds $session -c $working_directory hx "$selected_path"

    # Start lazygit if in git repo.
    if is_git_repo $selected_path; then
        tmux new-window -t $session -c $working_directory lazygit
    fi
    tmux select-window -t $session:1
fi

if [[ -z $TMUX ]]; then
    tmux attach -t $session
else
    tmux switch-client -t $session
fi

