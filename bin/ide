#!/bin/bash

HELP_OUTPUT=\
"Usage: $(basename $0) [path]

Arguments
    path (optional) - Path to project root directory.
"

UNDEFINED_EDITOR_ERROR_OUTPUT=\
"No editor was configured. Specify the editor you would like to use by setting the \$EDITOR variable.

For example, in order to use Vim as your editor, add following line to your ~/.zshrc:

export EDITOR=vim
"

TMUX_NOT_INSTALLED_ERROR_OUTPUT=\
"Did not find tmux, which is a required dependency for $(basename $0) command.

You can install tmux e.g. via homebrew by running

brew install tmux
"

is_git_repo() {
    local dir="$1"
    test $(git -C "$dir" rev-parse --is-inside-work-tree 2>/dev/null) = "true"
}

# Validate user input
if [[ $# -gt 1 ]]; then
    echo "Too many arguments. See $(basename $0) --help.">&2
    exit 1
elif [[ "$1" == "--help" || "$1" == "-h"  ]]; then
    echo "$HELP_OUTPUT"
    exit 0
elif [[ $# -eq 1 && ! -e "$1" ]]; then
    echo "Received an invalid path: $1">&2
    exit 1
fi

if [[ $# -eq 0 ]]; then
    selected_path=$PWD
else
    selected_path=$(realpath $1)
fi

if is_git_repo $selected_path; then
    working_directory=$(git -C $selected_path rev-parse --show-toplevel)
elif [[ -d "$1" ]]; then
    working_directory=$selected_path
else
    working_directory=$(dirname $selected_path)
fi

selected_path_hash=$(sha256 <<< "$selected_path")
session="$(basename $selected_path  | tr . _)-${selected_path_hash:0:4}"

if ! tmux has-session -t=$session 2> /dev/null; then
    tmux new-session -ds $session -c $working_directory hx "$selected_path"

    # Start lazygit if in git repo.
    if is_git_repo $selected_path; then
        tmux new-window -d -t $session -c $working_directory lazygit
    fi
fi

if [[ -z $TMUX ]]; then
    tmux attach -t $session
else
    tmux switch-client -t $session
fi

